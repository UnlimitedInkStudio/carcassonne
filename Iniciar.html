<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Carcassonne</title>
<style>
  @keyframes valid{
    0% {background-color: aqua;}
    25%{background-color: white;}
    50%{background-color: aqua;}
    75%{background-color: white;}
    100%{background-color: aqua;}
  }
  body { font-family: Arial; text-align: center; background: #f0f0f0; margin: 0; }
  #contenedor { display: flex; flex-direction: column; align-items: center; position: relative; }
  #tablero {
    width: 900px; height: 900px;
    display: grid;
    grid-template-columns: repeat(15, 60px);
    grid-template-rows: repeat(15, 60px);
    gap: 1px;
    background-color: #ccc;
    border: 3px solid #333;
    margin-top: 10px;
  }
  .celda { width: 60px; height: 60px; background: #fff; border: 1px solid #aaa; position: relative; }
  .valida { animation: valid 5s infinite; }
  .loseta { width: 60px; height: 60px; position: absolute; top: 0; left: 0; transform-origin: center center; }
  .meeple { width: 30px; height: 30px; position: absolute; bottom: 5px; right: 5px; }
  #barra-controles { position: sticky; bottom: 0; background: #222; padding: 10px; width: 100%; color: white; }
  #barra-controles button { margin: 5px; padding: 8px 14px; font-size: 14px; cursor: pointer; }
  #info { margin-top: 10px; font-weight: bold; }
  #jugador-actual {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 120px;
    height: 120px;
    border: 3px solid #333;
    border-radius: 10px;
    background-color: #fff;
  }

  /* Modal obligatorio */
  .modal-overlay {
    position: fixed;
    left:0; top:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .modal {
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:320px;
    box-shadow:0 8px 30px rgba(0,0,0,0.3);
    font-family:Arial, sans-serif;
  }
  .modal h3{margin:0 0 10px}
  .modal label{display:block; text-align:left; margin-top:8px;}
  .modal input{width:100%; padding:8px; box-sizing:border-box; margin-top:4px;}
  .modal .error{color:#b00020; font-size:13px; margin-top:8px; display:none;}
  .modal .actions{margin-top:12px; text-align:right;}
  .modal button{padding:8px 12px; border:0; background:#007bff; color:#fff; border-radius:4px; cursor:pointer;}
  .modal .link-create{display:block; margin-top:8px; text-align:left;}
  body.modal-open{overflow:hidden;}
</style>
</head>
<body>
<div id="contenedor">
  <h2>Carcassonne</h2>
  <img id="jugador-actual" src="imagenes/personaje_rojo.png" alt="Jugador Actual">
  <div id="tablero"></div>
  <div id="info"></div>
</div>

<div id="barra-controles">
  <button id="rotar">üîÑ Rotar loseta</button>
  <button id="confirmar">‚úÖ Confirmar colocaci√≥n</button>
</div>

<!-- Modal obligatorio de login -->
<div id="modal-overlay" class="modal-overlay" aria-modal="true" role="dialog" style="display:flex">
  <div class="modal" id="modal-form">
    <h3>Iniciar sesi√≥n</h3>
    <form id="loginForm" novalidate>
      <label for="modal-nick">Nickname</label>
      <input id="modal-nick" name="nick" type="text" autocomplete="off" required>

      <label for="modal-email">Email</label>
      <input id="modal-email" name="email" type="email" autocomplete="off" required>

      <label for="modal-pass">Contrase√±a</label>
      <input id="modal-pass" name="password" type="password" required>

      <div class="error" id="modal-error"></div>

      <div class="actions">
        <button id="modal-submit" type="submit">Ingresar</button>
      </div>

      <a class="link-create" href="Crear.html">¬øNo tienes cuenta? Crear cuenta</a>
    </form>
  </div>
</div>

<script>
/* --------------------------
  Variables / estado del juego
   (se mantienen como antes)
   NOTA: startGame() arrancar√° la partida
   s√≥lo despu√©s de login correcto.
---------------------------*/
let jugador = 1;
let losetasRestantes = 4;
let rotacion = 0;
let losetaActual = null;
let celdaSeleccionada = null;
let tipoActual = null;
let indiceActual = null;

const tablero = document.getElementById("tablero");
const info = document.getElementById("info");
const imgJugadorActual = document.getElementById("jugador-actual");
let celdas = [];
let estadoTablero = Array(225).fill(null);

// puntuaciones y seguimiento por jugador
let puntaje = [
  {vagos:0, ladrones:0, caballeros:0, paladines:0, total:0, diario:0, ultimo:0},
  {vagos:0, ladrones:0, caballeros:0, paladines:0, total:0, diario:0, ultimo:0},
  {vagos:0, ladrones:0, caballeros:0, paladines:0, total:0, diario:0, ultimo:0},
  {vagos:0, ladrones:0, caballeros:0, paladines:0, total:0, diario:0, ultimo:0}
];

// Variables globales solicitadas
window.jugador_rojo = 0;
window.jugador_azul = 0;
window.jugador_verde = 0;
window.jugador_amarillo = 0;
function actualizarVariablesJugadoresPorColor(){
  window.jugador_rojo = puntaje[0].total;
  window.jugador_azul = puntaje[1].total;
  window.jugador_verde = puntaje[2].total;
  window.jugador_amarillo = puntaje[3].total;
}
actualizarVariablesJugadoresPorColor();

let puntajeDiarioHist = [[],[],[],[]];
const puntosPorMeeple = { vago:3, ladron:1, caballero:4, paladin:5 };
let registros = [];

/* construir tablero (se puede hacer antes de login para que sea r√°pido)
   interacci√≥n est√° bloqueada por el overlay modal */
for (let i = 0; i < 225; i++) {
  const celda = document.createElement("div");
  celda.classList.add("celda");
  celda.dataset.ocupada = "false";
  celda.addEventListener("dragover", e => e.preventDefault());
  celda.addEventListener("drop", e => colocarTemporal(e, celda, i));
  tablero.appendChild(celda);
  celdas.push(celda);
}

const tiposLoseta = [
  { nombre: "Camino Recto", imagen: "imagenes/camino_recto.png", caminos: [0,2], maxRot: 1 },
  { nombre: "Camino Curva", imagen: "imagenes/camino_curva.png", caminos: [1,2], maxRot: 3 },
  { nombre: "Camino Cruce", imagen: "imagenes/camino_cruce.png", caminos: [0,1,2,3], maxRot: 0 },
  { nombre: "Ciudad Especial", imagen: "imagenes/ciudad_especial.png", caminos: [0,1,2,3], maxRot: 0 },
  { nombre: "Iglesia", imagen: "imagenes/iglesia.png", caminos: [0,1,2,3], maxRot: 0 }
];

/* --------------------------
  Funciones de juego (sin cambios importantes)
  Todas las funciones que ya ten√≠as se mantienen.
---------------------------*/
function actualizarImagenJugador() {
  const colores = ["rojo", "azul", "verde", "amarillo"];
  imgJugadorActual.src = `imagenes/personaje_${colores[jugador - 1]}.png`;
}

function turnoJugador() {
  if (losetasRestantes <= 0) { finalizarJuego(); return; }
  actualizarImagenJugador();
  alert(`Turno del jugador ${jugador}\nLosetas restantes: ${losetasRestantes}\nPuntos actuales: ${puntaje[jugador-1].total} pts`);
  info.innerText = `Jugador ${jugador} | Losetas restantes: ${losetasRestantes} | Puntos: ${puntaje[jugador-1].total} pts`;
  prepararNuevaLoseta();
  marcarEspaciosValidos();
}

function prepararNuevaLoseta() {
  if (losetaActual) losetaActual.remove();
  let random = Math.random();
  if (random < 0.07) {
    tipoActual = tiposLoseta[4]; // Iglesia
  } else if (random < 0.22) {
    tipoActual = tiposLoseta[3]; // Ciudad
  } else {
    tipoActual = tiposLoseta[Math.floor(Math.random() * 3)];
  }
  losetaActual = document.createElement("img");
  losetaActual.src = tipoActual.imagen;
  losetaActual.classList.add("loseta");
  losetaActual.draggable = true;
  losetaActual.dataset.tipo = tipoActual.nombre;
  losetaActual.style.position = "absolute";
  losetaActual.style.left = "50%";
  losetaActual.style.top = "90%";
  losetaActual.style.transform = "translate(-50%, -50%) rotate(0deg)";
  losetaActual.addEventListener("dragstart", e => { e.dataTransfer.setData("text/plain", "loseta"); });
  document.body.appendChild(losetaActual);
  rotacion = 0;
}

function adyacentes(i) {
  const cols = 15;
  const arr = [];
  if (i % cols !== 0) arr.push(i - 1);
  if (i % cols !== cols - 1) arr.push(i + 1);
  if (i - cols >= 0) arr.push(i - cols);
  if (i + cols < 225) arr.push(i + cols);
  return arr;
}

function obtenerDireccionesActivas(tipo, rot) {
  switch (tipo.nombre) {
    case "Camino Recto":
      return rot % 180 === 0 ? [0,2] : [1,3];
    case "Camino Curva":
      if (rot === 0) return [1,2];
      if (rot === 90) return [2,3];
      if (rot === 180) return [3,0];
      if (rot === 270) return [0,1];
      return [];
    case "Camino Cruce":
    case "Ciudad Especial":
    case "Iglesia":
      return [0,1,2,3];
    default:
      return [];
  }
}

function esColocacionValida(index) {
  if (!tipoActual) return false;
  if (tipoActual.nombre === "Camino Cruce") {
    return celdas[index].dataset.ocupada === "false";
  }
  const cols = 15;
  const ladosActivos = obtenerDireccionesActivas(tipoActual, rotacion);
  const vecinos = [
    { idx: index - 1, dir: 0 }, // izquierda
    { idx: index + 1, dir: 1 }, // derecha
    { idx: index - cols, dir: 2 }, // arriba
    { idx: index + cols, dir: 3 } // abajo
  ];
  const dirOpuesta = [1, 0, 3, 2];

  for (let v of vecinos) {
    const vecinoIdx = v.idx;
    const dir = v.dir;
    if (vecinoIdx < 0 || vecinoIdx >= 225) continue;
    if (dir === 0 && index % cols === 0) continue;
    if (dir === 1 && index % cols === cols - 1) continue;
    const vecinoData = estadoTablero[vecinoIdx];
    if (!vecinoData) continue;
    const vecinoLados = obtenerDireccionesActivas(vecinoData.tipo, vecinoData.rot);
    const ladoTiene = ladosActivos.includes(dir);
    const vecinoTiene = vecinoLados.includes(dirOpuesta[dir]);
    if (ladoTiene && !vecinoTiene) return false;
    if (!ladoTiene && vecinoTiene) return false;
  }
  return true;
}

function marcarEspaciosValidos() {
  celdas.forEach(c => c.classList.remove("valida"));
  if (!tipoActual) return;
  celdas.forEach((c, i) => {
    if (c.dataset.ocupada === "true") return;
    const tieneVecino = adyacentes(i).some(a => estadoTablero[a]);
    if (tieneVecino && esColocacionValida(i)) c.classList.add("valida");
  });
}

function colocarLosetaFija(index, tipo, rot) {
  const celda = celdas[index];
  celda.dataset.ocupada = "true";
  celda.classList.remove("valida");
  celda.innerHTML = "";
  const fija = document.createElement("img");
  fija.src = tipo.imagen;
  fija.classList.add("loseta");
  fija.style.transform = `rotate(${rot}deg)`;
  celda.appendChild(fija);
  estadoTablero[index] = { tipo: tipo, rot };
}

function colocarTemporal(e, celda, index) {
  e.preventDefault();
  if (!celda.classList.contains("valida")) return;
  if (celda.dataset.ocupada === "true") return;
  if (!esColocacionValida(index)) {
    alert("‚ùå No se puede colocar aqu√≠ (los caminos no coinciden)");
    return;
  }
  if (celdaSeleccionada && celdaSeleccionada !== celda) {
    celdaSeleccionada.innerHTML = "";
    celdaSeleccionada.classList.add("valida");
  }
  celdaSeleccionada = celda;
  indiceActual = index;
  celda.innerHTML = "";
  celda.appendChild(losetaActual);
  losetaActual.style.position = "relative";
  losetaActual.style.left = "0";
  losetaActual.style.top = "0";
  losetaActual.style.transform = `rotate(${rotacion}deg)`;
  losetaActual.draggable = false;
  celda.classList.remove("valida");
}

document.getElementById("rotar").onclick = () => {
  if (!losetaActual) return;
  rotacion += 90;
  if (rotacion >= 360) rotacion = 0;
  losetaActual.style.transform = `rotate(${rotacion}deg)`;
  marcarEspaciosValidos();
};

document.getElementById("confirmar").onclick = () => {
  if (!celdaSeleccionada) {
    alert("Coloca la loseta en una posici√≥n v√°lida antes de confirmar.");
    return;
  }
  colocarLosetaFija(indiceActual, tipoActual, rotacion);
  losetaActual.remove();
  losetaActual = null;
  celdaSeleccionada = null;
  losetasRestantes--;
  mostrarOpcionesMeeple();
};

function mostrarOpcionesMeeple() {
  const colores = ["rojo","azul","verde","amarillo"];
  const color = colores[jugador-1];
  const barra = document.getElementById("barra-controles");
  if (tipoActual.nombre === "Ciudad Especial") {
    barra.innerHTML = `
      <button id="btnCaballero">üèá Caballero_${color}</button>
      <button id="btnNada">üö´ Nada</button>`;
    document.getElementById("btnCaballero").onclick = () => finTurno("caballero", color);
    document.getElementById("btnNada").onclick = () => finTurno(null, null);
  } else if (tipoActual.nombre === "Iglesia") {
    barra.innerHTML = `
      <button id="btnPaladin">üõ°Ô∏è Paladin_${color}</button>
      <button id="btnNada">üö´ Nada</button>`;
    document.getElementById("btnPaladin").onclick = () => finTurno("paladin", color);
    document.getElementById("btnNada").onclick = () => finTurno(null, null);
  } else {
    barra.innerHTML = `
      <button id="btnLadron">üëÆ‚Äç‚ôÇÔ∏è Ladron_${color}</button>
      <button id="btnVago">üåæ Vago_${color}</button>
      <button id="btnNada">üö´ Nada</button>`;
    document.getElementById("btnLadron").onclick = () => finTurno("ladron", color);
    document.getElementById("btnVago").onclick = () => finTurno("vago", color);
    document.getElementById("btnNada").onclick = () => finTurno(null, null);
  }
}

function finTurno(tipoMeeple, color) {
  const registro = {jugador, loseta: tipoActual.nombre, meeple: tipoMeeple || "ninguno"};
  console.log(`[JUGADOR ${jugador}] coloc√≥ loseta: ${tipoActual.nombre} | meeple: ${registro.meeple}`);
  
  if (tipoMeeple) {
    const meeple = document.createElement("img");
    meeple.src = `imagenes/${tipoMeeple}_${color}.png`;
    meeple.classList.add("meeple");
    celdas[indiceActual].appendChild(meeple);
    estadoTablero[indiceActual].meeple = {tipo: tipoMeeple, color: color};
    if (tipoMeeple === "vago") puntaje[jugador-1].vagos++;
    if (tipoMeeple === "ladron") puntaje[jugador-1].ladrones++;
    if (tipoMeeple === "caballero") puntaje[jugador-1].caballeros++;
    if (tipoMeeple === "paladin") puntaje[jugador-1].paladines++;

    // calcular puntos por meeple colocado y acumular
    const puntos = puntosPorMeeple[tipoMeeple] || 0;
    puntaje[jugador-1].total += puntos;
    puntaje[jugador-1].diario += puntos;
    puntaje[jugador-1].ultimo = puntos;

    // sincronizar variables globales por color
    actualizarVariablesJugadoresPorColor();

    // informar cu√°nto sum√≥ y puntos actuales
    alert(`Jugador ${jugador}: +${puntos} pts por ${tipoMeeple}. Total actual: ${puntaje[jugador-1].total} pts`);
    console.log(`Jugador ${jugador} sum√≥ +${puntos} pts (meeple: ${tipoMeeple}). Total: ${puntaje[jugador-1].total}`);
  } else {
    puntaje[jugador-1].ultimo = 0;
    actualizarVariablesJugadoresPorColor();
  }

  registros.push(registro);

  // pasar al siguiente jugador
  jugador++;
  if (jugador > 4) jugador = 1;

  // Fin de d√≠a: cuando se vuelve al jugador 1 se considera que termin√≥ un ciclo (d√≠a)
  if (jugador === 1) {
    let resumenDia = "üìÖ Fin de d√≠a - Puntos por jugador este d√≠a:\n";
    for (let i = 0; i < 4; i++) {
      puntajeDiarioHist[i].push(puntaje[i].diario);
      resumenDia += `Jugador ${i+1}: ${puntaje[i].diario} pts\n`;
      puntaje[i].diario = 0; // reset diario para el siguiente d√≠a
    }
    alert(resumenDia);
    console.log(resumenDia);
  }

  document.getElementById("barra-controles").innerHTML = `
    <button id="rotar">üîÑ Rotar loseta</button>
    <button id="confirmar">‚úÖ Confirmar colocaci√≥n</button>`;
  document.getElementById("rotar").onclick = () => {
    if (!losetaActual) return;
    rotacion += 90;
    if (rotacion >= 360) rotacion = 0;
    losetaActual.style.transform = `rotate(${rotacion}deg)`;
    marcarEspaciosValidos();
  };
  document.getElementById("confirmar").onclick = () => {
    if (!celdaSeleccionada) {
      alert("Coloca la loseta en una posici√≥n v√°lida antes de confirmar.");
      return;
    }
    colocarLosetaFija(indiceActual, tipoActual, rotacion);
    losetaActual.remove();
    losetaActual = null;
    celdaSeleccionada = null;
    losetasRestantes--;
    mostrarOpcionesMeeple();
  };

  turnoJugador();
}

function finalizarJuego(){
  // asegurar variables actualizadas
  actualizarVariablesJugadoresPorColor();

  // usar puntaje.total como puntaje final de cada jugador
  const puntosFinales = puntaje.map((p,i) => ({
    jugador: i+1,
    puntos: p.total,
    vagos: p.vagos,
    ladrones: p.ladrones,
    caballeros: p.caballeros,
    paladines: p.paladines,
    historialDiario: puntajeDiarioHist[i]
  }));

  puntosFinales.sort((a,b) => b.puntos - a.puntos);
  const mejorJugador = puntosFinales[0];
  window.mejorJugador = mejorJugador;

  console.log("üìú HISTORIAL DE MOVIMIENTOS:");
  registros.forEach(r => console.log(`Jugador ${r.jugador}: Loseta ${r.loseta} | Meeple: ${r.meeple}`));

  let mensajeTop = `üèÜ Top 4 Jugadores (Puntos Totales):\n`;
  puntosFinales.forEach((p, i) => {
    mensajeTop += `${i+1}¬∞ Lugar: Jugador ${p.jugador} ‚Üí ${p.puntos} pts (Vagos: ${p.vagos}, Ladrones: ${p.ladrones}, Caballeros: ${p.caballeros}, Paladines: ${p.paladines})\n`;
    mensajeTop += `   Historial diario: [${p.historialDiario.join(", ")}]\n`;
  });
  mensajeTop += `\nPuntajes por color:\nRojo: ${window.jugador_rojo} | Azul: ${window.jugador_azul} | Verde: ${window.jugador_verde} | Amarillo: ${window.jugador_amarillo}\n`;
  mensajeTop += `\nüéñÔ∏è Ganador: Jugador ${mejorJugador.jugador} con ${mejorJugador.puntos} puntos!`;
  alert(mensajeTop);

  if (confirm("Presiona por la revancha guerrero")) {
    location.reload();
  } else {
    console.log("Jugador rechaz√≥ revancha ‚Üí redirigiendo a lobby.html");
    window.location.href = "lobby.html";
  }
}

/* --------------------------
  startGame: coloca loseta central y arranca el turno inicial
  Solo se llama cuando el login es correcto.
---------------------------*/
function startGame() {
  const centro = 7 * 15 + 7;
  colocarLosetaFija(centro, tiposLoseta[2], 0);
  turnoJugador();
}

/* --------------------------
  Login: env√≠a credenciales a login.php y espera respuesta JSON
  Respuesta esperada: { ok: true }  √≥  { ok:false, msg: "..."}
  Aseg√∫rate de tener archivo server/login.php (ejemplo m√°s abajo)
---------------------------*/
const overlay = document.getElementById('modal-overlay');
const form = document.getElementById('loginForm');
const err = document.getElementById('modal-error');

form.addEventListener('submit', async function(e){
  e.preventDefault();
  err.style.display = 'none';
  err.innerText = '';

  const nick = document.getElementById('modal-nick').value.trim();
  const email = document.getElementById('modal-email').value.trim();
  const pass = document.getElementById('modal-pass').value;

  if (!nick || !email || !pass) {
    err.innerText = 'Complete todos los campos.';
    err.style.display = 'block';
    return;
  }

  try {
    const resp = await fetch('login.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ nick, email, password: pass })
    });
    if (!resp.ok) throw new Error('Error de red');
    const data = await resp.json();
    if (data.ok) {
      // guardar info de usuario disponible globalmente
      window.user = { nick, email };
      // ocultar modal y permitir interacci√≥n
      overlay.style.display = 'none';
      document.body.classList.remove('modal-open');
      // arrancar la partida
      startGame();
    } else {
      err.innerText = data.msg || 'Credenciales inv√°lidas';
      err.style.display = 'block';
    }
  } catch (errNet) {
    console.error(errNet);
    err.innerText = 'Error de conexi√≥n al servidor';
    err.style.display = 'block';
  }
});

// evitar cerrar modal con clic fuera: mantener obligatorio
overlay.addEventListener('click', function(e){ e.stopPropagation(); });

// bloquear scroll al cargar (modal visible)
window.addEventListener('load', () => document.body.classList.add('modal-open'));
</script>
</body>
</html>